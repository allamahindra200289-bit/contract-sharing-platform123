<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Sharing Platform - Test</title>
    <!-- Load Supabase library first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
    <h1>Contract Sharing Platform - Test</h1>
    
    <div id="status">Initializing...</div>
    
    <form id="upload-form">
        <div>
            <label for="contract-title">Contract Title:</label>
            <input type="text" id="contract-title" required>
        </div>
        <div>
            <label for="contract-file">Select File:</label>
            <input type="file" id="contract-file" required>
        </div>
        <button type="submit">Upload Contract</button>
    </form>
    
    <div id="contracts-list"></div>
    
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Supabase is loaded
            if (typeof supabase === 'undefined') {
                document.getElementById('status').textContent = 'Error: Supabase library not loaded';
                console.error('Supabase library not loaded');
                return;
            }
            
            // Initialize Supabase
            const supabaseUrl = 'https://eufjbplrkntdmjttwvju.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1ZmpicGxya250ZG1qdHR3dmp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDUyMTYsImV4cCI6MjA3MTM4MTIxNn0.OWuk3OWIGSjwHv-HJJr6draSL0EAdjzQSHw1ZCLt6B0';
            const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
            
            const statusDiv = document.getElementById('status');
            const contractsList = document.getElementById('contracts-list');
            
            function updateStatus(message) {
                statusDiv.textContent = message;
                console.log(message);
            }
            
            // Test connection
            async function testConnection() {
                updateStatus("Testing Supabase connection...");
                
                try {
                    // Test storage
                    const { data: buckets, error: bucketError } = await supabase.storage.listBuckets();
                    if (bucketError) {
                        updateStatus(`Storage error: ${bucketError.message}`);
                        return;
                    }
                    
                    updateStatus(`Connected to Supabase. Found buckets: ${buckets.map(b => b.name).join(', ')}`);
                    
                    // Test database
                    const { data: contracts, error: dbError } = await supabase
                        .from('contracts')
                        .select('*')
                        .limit(1);
                        
                    if (dbError) {
                        updateStatus(`Database error: ${dbError.message}`);
                        return;
                    }
                    
                    updateStatus("Database connection successful");
                    fetchContracts();
                } catch (err) {
                    updateStatus(`Connection error: ${err.message}`);
                }
            }
            
            // Upload function
            async function uploadContract(event) {
                event.preventDefault();
                updateStatus("Starting upload...");
                
                const title = document.getElementById('contract-title').value;
                const file = document.getElementById('contract-file').files[0];
                
                if (!title || !file) {
                    updateStatus("Please provide a title and select a file");
                    return;
                }
                
                try {
                    // Upload to storage
                    updateStatus("Uploading to storage...");
                    const fileName = `${Date.now()}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('contracts')
                        .upload(fileName, file);
                        
                    if (uploadError) {
                        updateStatus(`Storage upload error: ${uploadError.message}`);
                        return;
                    }
                    
                    updateStatus(`File uploaded: ${uploadData.path}`);
                    
                    // Get public URL
                    const { data: urlData } = supabase.storage
                        .from('contracts')
                        .getPublicUrl(fileName);
                        
                    const fileUrl = urlData.publicUrl;
                    updateStatus(`Public URL: ${fileUrl}`);
                    
                    // Save to database
                    updateStatus("Saving to database...");
                    const { data: insertData, error: insertError } = await supabase
                        .from('contracts')
                        .insert([
                            { title: title, file_url: fileUrl }
                        ]);
                        
                    if (insertError) {
                        updateStatus(`Database insert error: ${insertError.message}`);
                        return;
                    }
                    
                    updateStatus("Upload successful!");
                    document.getElementById('upload-form').reset();
                    fetchContracts();
                } catch (err) {
                    updateStatus(`Upload error: ${err.message}`);
                }
            }
            
            // Fetch contracts
            async function fetchContracts() {
                updateStatus("Fetching contracts...");
                
                const { data, error } = await supabase
                    .from('contracts')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    updateStatus(`Fetch error: ${error.message}`);
                    return;
                }
                
                updateStatus(`Found ${data.length} contracts`);
                
                contractsList.innerHTML = '<h2>Contracts:</h2>';
                
                if (data.length === 0) {
                    contractsList.innerHTML += '<p>No contracts found</p>';
                    return;
                }
                
                data.forEach(contract => {
                    contractsList.innerHTML += `
                        <div>
                            <h3>${contract.title}</h3>
                            <a href="${contract.file_url}" target="_blank">View</a>
                            <p>Uploaded: ${new Date(contract.created_at).toLocaleString()}</p>
                        </div>
                    `;
                });
            }
            
            // Set up event listener
            document.getElementById('upload-form').addEventListener('submit', uploadContract);
            
            // Test connection on load
            testConnection();
        });
    </script>
</body>
</html>
